# 🚨 デプロイメント・セキュリティ管理ルールブック

## 📅 作成日: 2025年8月21日
## 🎯 目的: 2025年8月21日の方面機能トラブルの教訓を基に、今後の愚かな行為を防止

---

## ⚠️ **緊急事態の記録**

### 発生した問題
- **日時**: 2025年8月21日 8:30-10:30 (2時間)
- **問題**: TripList年間表示で方面情報が表示されない
- **真の原因**: App.jsxのCRUD操作でdestinationフィールドが漏れていた（5分で修正可能）
- **無駄な作業時間**: 約2時間15分
- **生成した余計なデプロイメント**: 9個

### 教訓
**「デプロイの回数 ≠ 問題解決の進捗」**

---

## 🚫 **絶対禁止事項**

### 1. デプロイメント関連
- ❌ **1つの問題につき3回以上のデプロイ実行**
- ❌ **ローカルテスト未完了でのデプロイ**
- ❌ **推測に基づくデプロイ（「多分これで直る」）**
- ❌ **デプロイ理由を記録せずに実行**

### 2. デバッグ関連
- ❌ **データフロー確認前の推測修正**
- ❌ **フロントエンド・バックエンドの両方同時修正**
- ❌ **Tree-shaking等の高度な問題を最初に疑う**
- ❌ **Git操作による問題解決の試行**

### 3. セキュリティ関連
- ❌ **API KeyをコマンドラインでRaw使用**
- ❌ **本番環境での直接データベース操作**
- ❌ **複数のデプロイメントURLの並行稼働**

---

## ✅ **必須実行手順**

### Phase 1: 問題の正確な把握（5分）
```
1. 症状の正確な記述
   - 「○○で××が表示されない」
   - 「期待値: ●●、実際: ■■」

2. 再現性の確認
   - ローカル環境での再現
   - 特定条件での発生確認

3. エラーログ・コンソール確認
   - ブラウザ開発者ツール
   - サーバーログ（必要時）
```

### Phase 2: データフロー確認（10分）
```
データの流れを順序立てて確認:
1. フォーム入力 → console.log確認
2. API送信 → Network tab確認
3. データベース保存 → 直接確認
4. データベース取得 → 直接確認
5. 画面表示 → 条件分岐確認
```

### Phase 3: 段階的修正（20分）
```
1. 最も可能性の高い箇所から修正
2. 1箇所ずつ修正・テスト
3. ローカル環境で完全確認
4. 修正理由と期待効果を記録
```

### Phase 4: デプロイと確認（10分）
```
1. 修正内容のコミットメッセージ明記
2. デプロイ実行（初回）
3. 本番環境での動作確認
4. 問題解決確認またはPhase 2に戻る
```

---

## 📊 **デプロイメント管理ルール**

### デプロイ実行の条件
- [ ] ローカル環境で問題解決を確認済み
- [ ] 変更内容を明確に説明できる
- [ ] 想定される副作用を理解している
- [ ] 前回デプロイから最低15分経過（緊急時除く）

### 1回のデプロイで許可される変更
- 🟢 **Single Responsibility**: 1つの問題に対する1つの修正
- 🟢 **Atomic Change**: 関連する変更のみを含む
- 🟢 **Reversible**: 簡単に戻せる変更

### デプロイ実行前チェックリスト
```bash
# 必須確認事項
1. ローカルビルド成功: npm run build
2. ESLintエラー解決: npm run lint (存在する場合)
3. 基本機能テスト: ログイン→主要機能→ログアウト
4. コミットメッセージ記入: git commit -m "具体的な修正内容"
```

---

## 🔒 **セキュリティ管理ルール**

### API Key管理
```bash
# ❌ 絶対禁止
curl -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." ...

# ✅ 正しい方法
export SUPABASE_KEY=$(grep VITE_SUPABASE_ANON_KEY .env | cut -d '=' -f2)
curl -H "apikey: $SUPABASE_KEY" ...
```

### 環境分離
- **開発環境**: ローカル・テスト・デバッグ用
- **本番環境**: エンドユーザー向けのみ
- **絶対禁止**: 本番環境での実験・テスト

### 緊急時の連絡
- **重大障害時**: 直ちに管理者（ユーザー）に報告
- **デプロイ失敗時**: 前バージョンへの即座復旧検討
- **セキュリティ事故時**: 該当機能の即座無効化

---

## 📝 **記録・文書化ルール**

### 必須記録事項
1. **問題発生時刻と解決時刻**
2. **試行した解決策の詳細**
3. **実際の原因と解決方法**
4. **今後の予防策**

### 定期レビュー
- **週次**: デプロイメント履歴の確認
- **月次**: セキュリティ設定の見直し
- **トラブル後**: 必ずポストモーテム実施

---

## 🎯 **KPI・制限値**

### デプロイメント制限
- **1問題あたり**: 最大2回のデプロイ
- **1日あたり**: 最大3回のプロダクションデプロイ
- **緊急時**: 上記制限を超える場合は事前承認必要

### 品質指標
- **問題解決時間**: 平均30分以内
- **デプロイ成功率**: 95%以上
- **ロールバック率**: 5%以下

---

## 🚨 **違反時の対応**

### Level 1: 注意喚起
- 連続3回のデプロイ失敗
- API Keyの不適切使用

### Level 2: 作業停止
- セキュリティ事故の発生
- 本番環境での実験的作業

### Level 3: 緊急対応
- データ漏洩・損失のリスク
- サービス停止状態の発生

---

## 📚 **参考資料・関連ドキュメント**

- `/learning-logs/2025-08-21.md` - 今回のトラブル詳細記録
- `/camping-car-apps/CLAUDE.md` - 開発ルール全般
- Vercel Dashboard: https://vercel.com/cyber-syokotas-projects/travel-journal
- Supabase Dashboard: https://supabase.com/dashboard/project/rwxllvnuuxabvgxpeuma

---

## ✍️ **このルールブックの更新**

- **更新頻度**: トラブル発生時・重要な変更時
- **更新責任**: 開発者（AIアシスタント）
- **承認**: プロジェクト管理者（ユーザー）

**最終更新**: 2025年8月21日  
**次回見直し**: 2025年9月1日  
**バージョン**: 1.0.0

---

> **💡 重要な心得**  
> 「デプロイは解決策ではない。正しい修正を正しい手順で実施した結果である。」