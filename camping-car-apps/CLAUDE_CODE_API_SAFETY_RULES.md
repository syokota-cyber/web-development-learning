# 🚨 Claude Code API安全運用規則

## 📋 絶対に守るべき鉄則

### **🛑 Rule 1: API認証は1回で決める**
- **禁止行為**: API キーの試行錯誤
- **正しい手順**: 公式ドキュメントで正確なキー形式を確認してから1回で設定
- **緊急時でも**: パニックせず、必ず確認してから実行

### **🛑 Rule 2: エラー発生時の段階的対応**
```
❌ 間違った対応:
1. エラー発生 → すぐに別のキーで試行
2. 失敗 → また別のキーで試行
3. 繰り返し → サービス制限発動

✅ 正しい対応:
1. エラー発生 → エラーメッセージの詳細分析
2. 公式ドキュメント確認 → 正しい設定方法を学習
3. 1回だけ正確に修正 → テスト実行
```

### **🛑 Rule 3: 本番環境への影響を常に考慮**
- **確認事項**: この操作は本番環境に影響するか？
- **テスト原則**: 開発環境でのみ検証、確認後に本番適用
- **ロールバック**: 必ず元の状態に戻せる手順を準備

### **🛑 Rule 4: サードパーティサービス制限の理解**
- **Supabase**: API制限、メール制限、セキュリティ制限
- **Vercel**: デプロイ制限、帯域幅制限
- **GitHub**: リクエスト制限
- **事前確認**: 各サービスの制限ポリシーを必ず理解

## 🔧 API認証問題の正しい対処法

### **Step 1: エラー詳細分析**
```bash
# エラーメッセージを完全に記録
console.error("完全なエラー情報:", error);

# ネットワークタブで実際のリクエストを確認
# 設定値が正しく送信されているか検証
```

### **Step 2: 公式ドキュメント確認**
1. Supabase公式ドキュメント → API Keys セクション
2. 正しいキー形式の確認（anon key: `eyJ...` JWT形式）
3. 環境変数の正しい設定方法確認

### **Step 3: 1回限りの正確な修正**
```bash
# 設定前の確認
echo "現在の設定:" $REACT_APP_SUPABASE_ANON_KEY

# 正確な設定（1回のみ）
# 公式から取得した正しいキーを設定

# 設定後の確認
echo "新しい設定:" $REACT_APP_SUPABASE_ANON_KEY
```

### **Step 4: 単一機能でのテスト**
```javascript
// 最小限のテスト（ログイン機能のみ）
// 成功を確認してから他の機能をテスト
```

## ⚠️ 危険な兆候とアラート

### **🚨 即座に停止すべき状況**
- 同じエラーが3回以上発生
- "Invalid API key" エラーが連続
- レート制限警告の表示
- 制限に関するメール受信

### **🟡 注意が必要な状況**
- 設定変更後に別のエラーが発生
- 本番環境でのテスト実行
- API キーの形式が不明確

## 📊 過去の失敗事例

### **2025年8月8日事件**
**経緯**: 
- Invalid login credentials エラー発生
- 4回連続で異なるAPIキーを試行
- publishable key と anon key を混同
- Supabaseがセキュリティメールを大量送信
- バウンス率上昇でプロジェクト制限発動

**損失**:
- 48時間のサービス停止
- 開発作業の中断
- ユーザー体験の悪化

**教訓**:
- 1回で正しく設定すれば10分で解決だった
- 公式ドキュメントを最初に確認すべきだった
- パニック対応が問題を悪化させた

## 🛠️ 事前準備チェックリスト

### **新しいサービス導入時**
- [ ] API制限ポリシーの確認
- [ ] 正しいキー形式の理解
- [ ] エラー対応手順の準備
- [ ] ロールバック手順の準備

### **API設定変更時**
- [ ] 現在の設定値をバックアップ
- [ ] 公式ドキュメントで正しい設定を確認
- [ ] 開発環境でテスト
- [ ] 本番環境に適用

### **エラー発生時**
- [ ] エラーメッセージの完全記録
- [ ] 再現手順の特定
- [ ] 公式ドキュメント確認
- [ ] 1回限りの修正実行

## 📞 緊急時の対応

### **サービス制限発動時**
1. **即座に停止**: これ以上のAPI試行を停止
2. **状況分析**: 制限内容と原因の特定
3. **公式サポート**: 必要に応じてサポートに連絡
4. **復旧計画**: 制限解除後の手順準備

### **本番環境停止時**
1. **影響範囲**: ユーザーへの影響を評価
2. **一時対応**: 可能な範囲での機能復旧
3. **根本修正**: 原因の完全解決
4. **再発防止**: ルールの見直しと強化

---

## 📝 このルールブックの使用方法

**毎回のAPI作業前に必ず確認**
- [ ] Rule 1-4を声に出して読む
- [ ] チェックリストを実行
- [ ] 不明点は作業を停止して調査

**定期レビュー**
- 月1回このルールブックを見直し
- 新しい失敗事例を追加
- ルールの改善と強化

---

**📅 作成日**: 2025年8月9日  
**🎯 目的**: Claude Code使用時のAPI制限事故防止  
**⚡ 緊急度**: 最高（即座に適用必須）  

**このルールブックはCLAUDE.mdに統合し、毎回作業前に確認すること**